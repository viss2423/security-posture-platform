<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SecPlat – Security Posture</title>
  <style>
    :root {
      --bg: #0f1419;
      --surface: #1a2332;
      --text: #e6edf3;
      --muted: #8b949e;
      --green: #3fb950;
      --amber: #d29922;
      --red: #f85149;
      --border: #30363d;
    }
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 1.5rem;
      min-height: 100vh;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border);
    }
    h1 { margin: 0; font-size: 1.5rem; font-weight: 600; }
    .links a {
      color: var(--muted);
      text-decoration: none;
      margin-left: 1rem;
    }
    .links a:hover { color: var(--text); }
    .summary {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      text-align: center;
    }
    .card .value { font-size: 1.75rem; font-weight: 700; }
    .card .label { font-size: 0.85rem; color: var(--muted); margin-top: 0.25rem; }
    .card.green .value { color: var(--green); }
    .card.amber .value { color: var(--amber); }
    .card.red .value { color: var(--red); }
    .card.score .value { color: var(--green); }
    section h2 { font-size: 1rem; margin-bottom: 0.75rem; color: var(--muted); }
    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--surface);
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid var(--border);
    }
    th, td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid var(--border); }
    th { color: var(--muted); font-weight: 500; font-size: 0.85rem; }
    tr:last-child td { border-bottom: none; }
    .badge { display: inline-block; padding: 0.2em 0.5em; border-radius: 4px; font-size: 0.8rem; }
    .badge.green { background: rgba(63, 185, 80, 0.2); color: var(--green); }
    .badge.amber { background: rgba(210, 153, 34, 0.2); color: var(--amber); }
    .badge.red { background: rgba(248, 81, 73, 0.2); color: var(--red); }
    .loading, .error { color: var(--muted); padding: 1rem; }
    .error { color: var(--red); }
  </style>
</head>
<body>
  <header>
    <h1>SecPlat – Security Posture</h1>
    <nav class="links">
      <a href="/api/docs">API docs</a>
      <a href="http://localhost:3001" target="_blank" rel="noopener">Grafana</a>
    </nav>
  </header>

  <div class="summary" id="summary">
    <div class="card green"><div class="value" id="green">–</div><div class="label">Green</div></div>
    <div class="card amber"><div class="value" id="amber">–</div><div class="label">Amber</div></div>
    <div class="card red"><div class="value" id="red">–</div><div class="label">Red</div></div>
    <div class="card score"><div class="value" id="score">–</div><div class="label">Avg score</div></div>
  </div>

  <section>
    <h2>Assets</h2>
    <div id="assets-loading" class="loading">Loading…</div>
    <div id="assets-error" class="error" style="display:none;"></div>
    <table id="assets-table" style="display:none;">
      <thead>
        <tr>
          <th>Asset</th>
          <th>Name</th>
          <th>State</th>
          <th>Score</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <script>
    const API = '/api';

    async function loadSummary() {
      try {
        const r = await fetch(API + '/posture/summary');
        if (!r.ok) throw new Error(r.status + ' ' + r.statusText);
        const d = await r.json();
        document.getElementById('green').textContent = d.green ?? '–';
        document.getElementById('amber').textContent = d.amber ?? '–';
        document.getElementById('red').textContent = d.red ?? '–';
        document.getElementById('score').textContent = d.posture_score_avg != null ? d.posture_score_avg : '–';
      } catch (e) {
        document.getElementById('summary').innerHTML = '<div class="error">Failed to load summary: ' + e.message + '</div>';
      }
    }

    async function loadAssets() {
      const loading = document.getElementById('assets-loading');
      const errEl = document.getElementById('assets-error');
      const table = document.getElementById('assets-table');
      const tbody = table.querySelector('tbody');
      try {
        const r = await fetch(API + '/posture');
        if (!r.ok) throw new Error(r.status + ' ' + r.statusText);
        const d = await r.json();
        loading.style.display = 'none';
        errEl.style.display = 'none';
        table.style.display = 'table';
        tbody.innerHTML = (d.items || []).map(function (a) {
          const state = (a.posture_state || 'unknown').toLowerCase();
          const score = a.posture_score != null ? a.posture_score : '–';
          return '<tr><td>' + (a.asset_key || '') + '</td><td>' + (a.name || '') + '</td><td><span class="badge ' + state + '">' + state + '</span></td><td>' + score + '</td></tr>';
        }).join('') || '<tr><td colspan="4">No assets</td></tr>';
      } catch (e) {
        loading.style.display = 'none';
        errEl.textContent = 'Failed to load assets: ' + e.message;
        errEl.style.display = 'block';
      }
    }

    loadSummary();
    loadAssets();
    setInterval(loadSummary, 60000);
    setInterval(loadAssets, 60000);
  </script>
</body>
</html>
